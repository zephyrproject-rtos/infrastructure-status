# Publish incident issues to Gist
name: Incident Publisher

on:
  workflow_dispatch:
    branches:
    - main
  schedule:
  # Run every 5 minutes
  - cron: '*/5 * * * *'

concurrency:
  group: "incident-publisher"
  cancel-in-progress: false

defaults:
  run:
    working-directory: incident-publisher

jobs:
  publish:
    name: Publish
    runs-on: ubuntu-22.04

    env:
      AWS_ACCESS_KEY_ID: "${{ secrets.AWS_ACCESS_KEY_ID }}"
      AWS_SECRET_ACCESS_KEY: "${{ secrets.AWS_SECRET_ACCESS_KEY }}"
      AWS_DEFAULT_REGION: "us-east-2"

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: "22"

    - name: Install dependencies
      run: |
        npm install

    - name: Build incident-publisher
      run: |
        npm run build

    - name: Install incident-publisher
      run: |
        npm install -g .

    - name: Run incident-publisher
      run: |
        incident-publisher \
          -o zephyrproject-rtos \
          -r infrastructure-status \
          -t ${{ secrets.ZB_GITHUB_TOKEN }} \

    - name: Upload to S3 bucket
      run: |
        aws s3 cp current_incidents.json s3://statuspage-data/
        aws s3 cp past_incidents.json s3://statuspage-data/
